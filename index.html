<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¡ãƒ©ã‚¢ãƒ—ãƒªé¢¨ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚·ã‚¹ãƒ†ãƒ </title>
    <!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚¢ãƒ—ãƒªå…¨ä½“ã‚’ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«è¿‘ã„å½¢ã§è¨­å®š */
        body {
            /* ç”»é¢å…¨ä½“ã‚’å ã‚ã‚‹ */
            height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
        }
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ */
        .preview-wrapper {
            flex-grow: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨ã¦å ã‚ã‚‹ */
            position: relative;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        /* ãƒ“ãƒ‡ã‚ªè¦ç´ ï¼šã‚ºãƒ¼ãƒ ã®åŸºç‚¹ã¨ãªã‚Šã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ä¸­å¤®ã«é…ç½® */
        #video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover; /* ç”»é¢ã‚’è¦†ã†ã‚ˆã†ã«æ‹¡å¤§ (ã‚ºãƒ¼ãƒ ã®èµ·ç‚¹) */
            transform-origin: center center;
            transition: transform 0.1s ease-out; /* ã‚ºãƒ¼ãƒ ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹ */
        }
        /* ã‚ºãƒ¼ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        #zoom-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.4);
            outline: none;
            opacity: 0.8;
            transition: opacity .2s;
            border-radius: 3px;
        }
        #zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #fff;
            border: 2px solid #3b82f6; /* Blue-500 */
            cursor: pointer;
            border-radius: 50%;
        }
        /* ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 10px;
        }
        .gallery-item {
            aspect-ratio: 1 / 1;
            width: 100%;
            cursor: pointer;
            object-fit: cover;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .gallery-item:active {
            transform: scale(0.95);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-black text-white font-sans">
    
    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ -->
    <div class="preview-wrapper">
        <video id="video-preview" autoplay playsinline muted class="transform scale-100"></video>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ -->
        <div id="status-message" class="absolute top-0 left-0 right-0 p-3 text-center transition-all duration-300 hidden z-20 pointer-events-none">
            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯JSã§æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>

        <!-- ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ä¸Šéƒ¨ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ -->
        <div class="absolute top-4 w-full px-4 z-10">
            <div id="zoom-control-container" class="bg-gray-800/70 p-3 rounded-lg shadow-xl max-w-sm mx-auto flex items-center space-x-3 hidden">
                <span class="text-sm font-bold w-10 text-right">1x</span>
                <input type="range" id="zoom-slider" min="1.0" max="4.0" step="0.1" value="1.0">
                <span id="zoom-value-display" class="text-sm font-bold w-10 text-left">1.0x</span>
            </div>
        </div>
    </div>
    
    <!-- å›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ï¼šãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã¨ä¸»è¦æ“ä½œãƒœã‚¿ãƒ³ -->
    <div class="fixed bottom-0 left-0 right-0 bg-gray-900/95 p-4 z-30 shadow-2xl">
        
        <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã‚¿ãƒ– -->
        <div class="flex justify-center space-x-6 mb-4 text-lg font-semibold">
            <button id="mode-photo" class="px-4 py-1 rounded-full transition duration-150 border border-transparent text-blue-400 border-blue-400">
                å†™çœŸ
            </button>
            <button id="mode-record" class="px-4 py-1 rounded-full text-white/50 hover:text-white transition duration-150">
                éŒ²éŸ³
            </button>
        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ç¾¤ (ä¸­å¤®ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’å«ã‚€) -->
        <div class="flex items-center justify-between h-20">
            
            <!-- å·¦ä¸‹: ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ãƒœã‚¿ãƒ³ -->
            <button id="switch-camera-btn" class="w-12 h-12 flex items-center justify-center rounded-full bg-gray-700 hover:bg-gray-600 transition duration-150 shadow-lg disabled:opacity-30">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>

            <!-- ä¸­å¤®: ãƒ¡ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ (å†™çœŸãƒ¢ãƒ¼ãƒ‰) -->
            <div id="photo-controls" class="flex justify-center">
                <button id="capture-image-btn" class="w-16 h-16 bg-white border-4 border-gray-400 rounded-full flex items-center justify-center transition duration-150 disabled:opacity-50 active:scale-90 hover:scale-105">
                    <div class="w-12 h-12 bg-white rounded-full border border-gray-900"></div>
                </button>
            </div>
            
            <!-- ä¸­å¤®: ãƒ¡ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ (éŒ²éŸ³ãƒ¢ãƒ¼ãƒ‰) -->
            <div id="record-controls" class="flex justify-center hidden">
                <!-- éŒ²éŸ³é–‹å§‹ãƒœã‚¿ãƒ³ -->
                <button id="start-recording-btn" class="w-16 h-16 bg-red-600 border-4 border-red-300 rounded-full flex items-center justify-center transition duration-150 disabled:opacity-50 active:scale-90 hover:scale-105">
                    <div class="w-12 h-12 bg-red-600 rounded-full border border-gray-900"></div>
                </button>
                <!-- éŒ²éŸ³åœæ­¢ãƒœã‚¿ãƒ³ -->
                <button id="stop-recording-btn" class="w-16 h-16 bg-gray-300 border-4 border-red-600 rounded-lg flex items-center justify-center transition duration-150 ml-4 disabled:opacity-50 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="currentColor" viewBox="0 0 24 24"><path d="M5 5h14v14H5z"/></svg>
                </button>
            </div>

            <!-- å³ä¸‹: ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒœã‚¿ãƒ³ -->
            <button id="gallery-btn" class="w-12 h-12 flex items-center justify-center rounded-lg bg-gray-700 hover:bg-gray-600 transition duration-150 shadow-lg">
                <span id="gallery-thumbnail" class="w-10 h-10 rounded-md bg-gray-500 flex items-center justify-center text-sm font-bold text-white overflow-hidden">
                    0
                </span>
            </button>
        </div>
    </div>
    
    <!-- ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« (åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º) -->
    <div id="gallery-modal" class="fixed inset-0 bg-black/95 z-40 hidden flex flex-col p-4">
        <div class="flex justify-between items-center pb-4 border-b border-gray-700">
            <h2 class="text-2xl font-bold">ä¿å­˜ã•ã‚ŒãŸå†™çœŸ (ã‚¿ãƒƒãƒ—ã§ä¿å­˜)</h2>
            <button id="close-gallery-btn" class="p-2 text-white hover:text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div id="gallery-container" class="gallery-grid mt-4">
            <p class="text-gray-400 col-span-3 text-center">ã¾ã å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
        <p class="text-center text-sm text-gray-400 mt-4">å†™çœŸã‚’ã‚¿ãƒƒãƒ—ï¼ˆã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ï¼‰ã™ã‚‹ã¨ã€ãƒ‡ãƒã‚¤ã‚¹ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
    </div>

    <!-- ã‚­ãƒ£ãƒ—ãƒãƒ£ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ (éè¡¨ç¤º) -->
    <canvas id="capture-canvas"></canvas>

    <script>
        // DOMè¦ç´ ã®å–å¾—
        const videoPreview = document.getElementById('video-preview');
        const captureCanvas = document.getElementById('capture-canvas');
        const statusMessage = document.getElementById('status-message');
        const zoomSlider = document.getElementById('zoom-slider');
        const zoomControlContainer = document.getElementById('zoom-control-container');
        const zoomValueDisplay = document.getElementById('zoom-value-display');

        const modePhoto = document.getElementById('mode-photo');
        const modeRecord = document.getElementById('mode-record');
        const photoControls = document.getElementById('photo-controls');
        const recordControls = document.getElementById('record-controls');
        
        const captureImageBtn = document.getElementById('capture-image-btn');
        const startRecordingBtn = document.getElementById('start-recording-btn');
        const stopRecordingBtn = document.getElementById('stop-recording-btn');
        const switchCameraBtn = document.getElementById('switch-camera-btn');
        const galleryBtn = document.getElementById('gallery-btn');
        const galleryModal = document.getElementById('gallery-modal');
        const closeGalleryBtn = document.getElementById('close-gallery-btn');
        const galleryContainer = document.getElementById('gallery-container');
        const galleryThumbnail = document.getElementById('gallery-thumbnail');

        // çŠ¶æ…‹å¤‰æ•°
        let currentStream = null;
        let audioRecorder = null;
        let audioChunks = [];
        let videoDevices = [];
        let currentCameraIndex = 0;
        let currentMode = 'photo'; // 'photo' or 'record'
        let capturedImages = []; // ã‚®ãƒ£ãƒ©ãƒªãƒ¼ç”¨ã®Blob URLã¨Blobãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        let currentZoom = 1.0;

        const APP_NAME = 'CameraApp';

        // ======================================================
        // UI/ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†
        // ======================================================
        
        /**
         * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
         * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         * @param {string} type - 'success', 'error', 'info' ã®ã„ãšã‚Œã‹
         */
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-500', 'bg-green-600', 'bg-blue-600');
            statusMessage.classList.add('p-3', 'rounded-b-lg', 'font-bold', 'text-white', 'opacity-90');
            
            switch (type) {
                case 'error':
                    statusMessage.classList.add('bg-red-500');
                    break;
                case 'success':
                    statusMessage.classList.add('bg-green-600');
                    break;
                case 'info':
                default:
                    statusMessage.classList.add('bg-blue-600');
                    break;
            }
            // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }

        /**
         * ãƒ¢ãƒ¼ãƒ‰ï¼ˆå†™çœŸ/éŒ²éŸ³ï¼‰ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
         * @param {string} mode - 'photo' ã¾ãŸã¯ 'record'
         */
        function switchMode(mode) {
            if (currentMode === mode) return; // åŒã˜ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ä½•ã‚‚ã—ãªã„

            currentMode = mode;
            if (mode === 'photo') {
                photoControls.classList.remove('hidden');
                recordControls.classList.add('hidden');
                
                // å†™çœŸãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«
                modePhoto.classList.add('border-blue-400', 'text-blue-400');
                modePhoto.classList.remove('text-white/50', 'border-transparent');
                
                // éŒ²éŸ³ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                modeRecord.classList.remove('border-red-400', 'text-red-400');
                modeRecord.classList.add('text-white/50', 'border-transparent');
                
                zoomControlContainer.classList.remove('hidden'); // å†™çœŸãƒ¢ãƒ¼ãƒ‰ã§ã‚ºãƒ¼ãƒ ã‚’è¡¨ç¤º
            } else { // 'record'
                // éŒ²éŸ³ä¸­ã®å ´åˆã¯åˆ‡ã‚Šæ›¿ãˆã‚’è¨±å¯ã—ãªã„
                if (audioRecorder && audioRecorder.state === 'recording') {
                    showStatus('éŒ²éŸ³ä¸­ã¯ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã›ã‚“ã€‚', 'error');
                    return;
                }
                
                photoControls.classList.add('hidden');
                recordControls.classList.remove('hidden');
                
                // éŒ²éŸ³ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«
                modeRecord.classList.add('border-red-400', 'text-red-400');
                modeRecord.classList.remove('text-white/50', 'border-transparent');
                
                // å†™çœŸãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                modePhoto.classList.remove('border-blue-400', 'text-blue-400');
                modePhoto.classList.add('text-white/50', 'border-transparent');
                
                zoomControlContainer.classList.add('hidden'); // éŒ²éŸ³ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚ºãƒ¼ãƒ ã‚’éš ã™
                
                // ã‚ºãƒ¼ãƒ å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
                zoomSlider.value = 1.0;
                updateZoom();
            }
        }

        // ======================================================
        // ã‚«ãƒ¡ãƒ©ãƒ»ãƒ‡ãƒã‚¤ã‚¹æ“ä½œ
        // ======================================================

        /**
         * ç¾åœ¨ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢ã—ã¾ã™ã€‚
         */
        function stopMediaStream(stream) {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }

        /**
         * æŒ‡å®šã•ã‚ŒãŸã‚«ãƒ¡ãƒ©IDã§ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã€‚
         * @param {string} cameraId - é¸æŠã•ã‚ŒãŸã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã®ID
         */
        async function startCamera(cameraId) {
            stopMediaStream(currentStream); // æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢

            try {
                // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãªã„ (ç„¡éŸ³æ’®å½±ã‚’ä¿è¨¼)
                const constraints = {
                    video: {
                        deviceId: cameraId ? { exact: cameraId } : undefined
                    }
                };
                
                showStatus('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...', 'info');
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                videoPreview.srcObject = currentStream;
                videoPreview.onloadedmetadata = () => {
                    videoPreview.play();
                    showStatus('ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚', 'success');
                    captureImageBtn.disabled = false;
                };

            } catch (err) {
                console.error("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ", err);
                showStatus(`ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.name}`, 'error');
                captureImageBtn.disabled = true;
            }
        }

        /**
         * åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã‚’åˆ—æŒ™ã—ã€åˆæœŸã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¾ã™ã€‚
         */
        async function setupCameraDevices() {
            try {
                // åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«æ¨©é™ã‚’è¦æ±‚ã™ã‚‹ãŸã‚ã«ãƒ€ãƒŸãƒ¼ã®getUserMediaã‚’è©¦ã¿ã‚‹
                await navigator.mediaDevices.getUserMedia({ video: true }).then(stream => stopMediaStream(stream));

                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length === 0) {
                    showStatus('ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
                    switchCameraBtn.disabled = true;
                    return;
                }

                if (videoDevices.length > 1) {
                    switchCameraBtn.disabled = false;
                } else {
                    switchCameraBtn.disabled = true;
                }

                // æœ€åˆã®ãƒ‡ãƒã‚¤ã‚¹ã§ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
                await startCamera(videoDevices[currentCameraIndex].deviceId);

            } catch (err) {
                console.error("ãƒ‡ãƒã‚¤ã‚¹ã®åˆ—æŒ™ã«å¤±æ•—ã—ã¾ã—ãŸ: ", err);
                showStatus(`ãƒ¡ãƒ‡ã‚£ã‚¢æ¨©é™ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.name}`, 'error');
                switchCameraBtn.disabled = true;
            }
        }

        /**
         * æ¬¡ã®åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
         */
        function switchCamera() {
            if (videoDevices.length <= 1) return;

            currentCameraIndex = (currentCameraIndex + 1) % videoDevices.length;
            const nextCameraId = videoDevices[currentCameraIndex].deviceId;
            startCamera(nextCameraId);
            
            showStatus(`ã‚«ãƒ¡ãƒ©ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ: ${videoDevices[currentCameraIndex].label || 'Camera ' + (currentCameraIndex + 1)}`, 'info');
        }

        // ======================================================
        // ã‚ºãƒ¼ãƒ æ©Ÿèƒ½ (CSS transform: scale)
        // ======================================================
        
        /**
         * ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã«åŸºã¥ã„ã¦ã€ãƒ“ãƒ‡ã‚ªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’CSSã§æ‹¡å¤§ã—ã¾ã™ã€‚
         */
        function updateZoom() {
            currentZoom = parseFloat(zoomSlider.value);
            // CSSã®transformãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›´æ–°ã—ã¦æ‹¡å¤§
            videoPreview.style.transform = `scale(${currentZoom})`;
            zoomValueDisplay.textContent = `${currentZoom.toFixed(1)}x`;
        }


        // ======================================================
        // ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ (ã‚­ãƒ£ãƒ—ãƒãƒ£/éŒ²éŸ³/ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰)
        // ======================================================

        /**
         * ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Blobã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æ±ç”¨é–¢æ•°ã€‚
         * @param {Blob} blob - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹Blobãƒ‡ãƒ¼ã‚¿
         * @param {string} filename - ä¿å­˜æ™‚ã®ãƒ•ã‚¡ã‚¤ãƒ«å
         */
        function downloadFile(blob, filename) {
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            
            // å¾Œå‡¦ç†
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /**
         * ç„¡éŸ³ã§ç¾åœ¨ã®ãƒ“ãƒ‡ã‚ªãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã€ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã«è¿½åŠ ã—ã¾ã™ã€‚
         */
        function captureImage() {
            if (!currentStream || videoPreview.paused) {
                showStatus('ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’ç¾åœ¨ã®ãƒ“ãƒ‡ã‚ªã®è§£åƒåº¦ã¨ä¸€è‡´ã•ã›ã‚‹
            captureCanvas.width = videoPreview.videoWidth;
            captureCanvas.height = videoPreview.videoHeight;
            const ctx = captureCanvas.getContext('2d');
            
            // ãƒ“ãƒ‡ã‚ªãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
            ctx.drawImage(videoPreview, 0, 0, captureCanvas.width, captureCanvas.height);

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‹ã‚‰PNGç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’Blobã¨ã—ã¦å–å¾—
            captureCanvas.toBlob((blob) => {
                if (blob) {
                    const imageUrl = URL.createObjectURL(blob);
                    capturedImages.push({ imageUrl, blob });
                    updateGalleryThumbnail();
                    showStatus('å†™çœŸã‚’æ’®ã‚Šã¾ã—ãŸï¼', 'success');
                } else {
                    showStatus('ç”»åƒãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                }
            }, 'image/png');
        }
        
        /**
         * éŸ³å£°éŒ²éŸ³ã‚’é–‹å§‹ã—ã¾ã™ã€‚
         */
        async function startRecording() {
            try {
                // ãƒ“ãƒ‡ã‚ªã¨ã¯åˆ¥ã«ã€ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®ã¿ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å–å¾—
                const audioConstraints = { audio: true }; 
                const audioStream = await navigator.mediaDevices.getUserMedia(audioConstraints);

                audioChunks = [];
                // MediaRecorderã®åˆæœŸåŒ–
                audioRecorder = new MediaRecorder(audioStream);

                audioRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                audioRecorder.onstop = () => {
                    // éŒ²éŸ³ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                    stopMediaStream(audioStream);
                    
                    const mimeType = audioChunks[0]?.type || 'audio/webm';
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const extension = mimeType.split('/')[1].split(';')[0];
                    const filename = `${APP_NAME}_Audio_${timestamp}.${extension}`;
                    
                    downloadFile(audioBlob, filename);
                    showStatus(`éŒ²éŸ³ã‚’åœæ­¢ã—ã€'${filename}'ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸã€‚`, 'success');
                    
                    // UIãƒªã‚»ãƒƒãƒˆ
                    startRecordingBtn.classList.remove('hidden');
                    stopRecordingBtn.classList.add('hidden');
                };

                audioRecorder.start();
                showStatus('ğŸ”´ éŒ²éŸ³ä¸­...', 'info');
                
                // UIã®çŠ¶æ…‹ã‚’æ›´æ–°
                startRecordingBtn.classList.add('hidden');
                stopRecordingBtn.classList.remove('hidden');

            } catch (err) {
                console.error("éŸ³å£°éŒ²éŸ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ", err);
                showStatus(`éŒ²éŸ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.name} (ãƒã‚¤ã‚¯æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„)`, 'error');
            }
        }
        
        /**
         * éŸ³å£°éŒ²éŸ³ã‚’åœæ­¢ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã™ã€‚
         */
        function stopRecording() {
            if (audioRecorder && audioRecorder.state === 'recording') {
                audioRecorder.stop();
            }
        }

        // ======================================================
        // ã‚®ãƒ£ãƒ©ãƒªãƒ¼æ©Ÿèƒ½
        // ======================================================

        /**
         * ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ï¼ˆå³ä¸‹ãƒœã‚¿ãƒ³ï¼‰ã‚’æ›´æ–°ã—ã¾ã™ã€‚
         */
        function updateGalleryThumbnail() {
            if (capturedImages.length > 0) {
                // æœ€æ–°ã®ç”»åƒã‚’ã‚µãƒ ãƒã‚¤ãƒ«ã¨ã—ã¦è¡¨ç¤º
                const latestImage = capturedImages[capturedImages.length - 1];
                galleryThumbnail.style.backgroundImage = `url(${latestImage.imageUrl})`;
                galleryThumbnail.style.backgroundSize = 'cover';
                galleryThumbnail.style.backgroundPosition = 'center';
                galleryThumbnail.textContent = ''; 
                galleryThumbnail.classList.remove('bg-gray-500');
            } else {
                // ç”»åƒãŒãªã„å ´åˆã¯ã€Œ0ã€ã‚’è¡¨ç¤º
                galleryThumbnail.style.backgroundImage = 'none';
                galleryThumbnail.textContent = '0';
                galleryThumbnail.classList.add('bg-gray-500');
            }
        }

        /**
         * ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€ç”»åƒã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
         */
        function openGallery() {
            galleryModal.classList.remove('hidden');
            galleryContainer.innerHTML = '';
            
            if (capturedImages.length === 0) {
                galleryContainer.innerHTML = '<p class="text-gray-400 col-span-3 text-center py-10">ã¾ã å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            // æ–°ã—ã„å†™çœŸã‹ã‚‰è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ãƒªãƒãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ—
            const imagesToShow = [...capturedImages].reverse();
            
            imagesToShow.forEach((imgData) => { 
                const imgElement = document.createElement('img');
                imgElement.src = imgData.imageUrl;
                imgElement.alt = 'Captured Image';
                imgElement.classList.add('gallery-item');
                
                // ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã§ä¿å­˜ (é•·æŠ¼ã—è¦æ±‚ã¸ã®ä»£æ›¿)
                const saveHandler = () => {
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const filename = `${APP_NAME}_GalleryImage_${timestamp}.png`;
                    downloadFile(imgData.blob, filename);
                    showStatus(`å†™çœŸã‚’ãƒ‡ãƒã‚¤ã‚¹ã«ä¿å­˜ã—ã¾ã—ãŸ: ${filename}`, 'success');
                };

                // PCã§ã®ã‚¯ãƒªãƒƒã‚¯ã€ãƒ¢ãƒã‚¤ãƒ«ã§ã®ã‚¿ãƒƒãƒ—ã«å¯¾å¿œ
                imgElement.addEventListener('click', saveHandler);
                
                galleryContainer.appendChild(imgElement);
            });
        }

        /**
         * ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã™ã€‚
         */
        function closeGallery() {
            galleryModal.classList.add('hidden');
        }

        // ======================================================
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®šã¨åˆæœŸåŒ–
        // ======================================================
        
        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        modePhoto.addEventListener('click', () => switchMode('photo'));
        modeRecord.addEventListener('click', () => switchMode('record'));
        
        // ã‚«ãƒ¡ãƒ©æ“ä½œ
        switchCameraBtn.addEventListener('click', switchCamera);
        
        // ã‚ºãƒ¼ãƒ æ“ä½œ
        zoomSlider.addEventListener('input', updateZoom);

        // ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ»éŒ²éŸ³
        captureImageBtn.addEventListener('click', captureImage);
        startRecordingBtn.addEventListener('click', startRecording);
        stopRecordingBtn.addEventListener('click', stopRecording);
        
        // ã‚®ãƒ£ãƒ©ãƒªãƒ¼æ“ä½œ
        galleryBtn.addEventListener('click', openGallery);
        closeGalleryBtn.addEventListener('click', closeGallery);
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã®åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', () => {
            setupCameraDevices();
            switchMode('photo'); // åˆæœŸãƒ¢ãƒ¼ãƒ‰ã‚’å†™çœŸã«è¨­å®š
            updateZoom(); // åˆå›ã‚ºãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ (1.0x)
            updateGalleryThumbnail();
        });

    </script>
</body>
</html>
